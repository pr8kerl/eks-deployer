#!/usr/bin/env bash

set -euo pipefail

if [ "$#" -lt 1 ]; then
  echo
  echo "usage: auth-nodes clustername"
  echo "  ie. auth-nodes lebkuchen"
  exit 255
fi

clustername=${1}

noderole=$(aws cloudformation list-stack-resources --stack-name kube-controlplane-${clustername} |jq -r '.StackResourceSummaries[]|select(.LogicalResourceId == "NodeInstanceRole")|.PhysicalResourceId')
if [[ -z "$noderole" ]]; then
  echo "error: couldn't find NodeInstanceRole"
  exit 1
fi

aws eks update-kubeconfig --name ${clustername}
rc=$?
if [[ ! $rc ]]; then
  echo "error: couldn't configure kubeconfig"
  exit 1
fi

echo 
echo updating kube-system/aws-auth configmap for cluster ${clustername} with node instance role ${noderole}
cat <<EOF | kubectl apply -f -
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: aws-auth
  namespace: kube-system
data:
  mapRoles: |
    - rolearn: ${noderole}
      username: system:node:{{EC2PrivateDNSName}}
      groups:
        - system:bootstrappers
        - system:nodes
EOF
