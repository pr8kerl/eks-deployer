#!/usr/bin/env bash

set -euo pipefail

if [ "$#" -lt 2 ]; then
  echo
  echo "usage: tag-resources development clustername"
  echo "  ie. tag-resources development lebkuchen"
  exit 255
fi

vpc=${1}
clustername=${2}
dcr="docker-compose run --rm"

subnets=$(aws cloudformation list-stack-resources --stack-name kube-vpc-${vpc} |jq -r '.StackResourceSummaries[]|select(.LogicalResourceId |test("KubeP."))|select(.ResourceType == "AWS::EC2::Subnet")|.PhysicalResourceId')
for subnet in $subnets
do
  echo subnet $subnet
  aws ec2 create-tags --resources "${subnet}" --tags Key=kubernetes.io/cluster/${clustername},Value=shared
done

vpc=$(aws cloudformation list-stack-resources --stack-name kube-vpc-${vpc} |jq -r '.StackResourceSummaries[]|select(.ResourceType == "AWS::EC2::VPC")|.PhysicalResourceId')
aws ec2 create-tags --resources "${vpc}" --tags Key=kubernetes.io/cluster/${clustername},Value=shared

echo tagged subnets: $subnets
echo tagged vpc: $vpc
